<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta itemprop="image" content="screenshot.png">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
    <link rel="stylesheet" href="./scripts/botui.min.css" />
    <link rel="stylesheet" href="./scripts/botui-theme-default.css" />
    <script src="https://cdn.jsdelivr.net/vue/latest/vue.min.js"></script>
    <script src="https://unpkg.com/botui/build/botui.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="./scripts/main.js"></script>

  </head>
  <body style=-"background-color:transparent;">
    <div id="scene">

     <canvas id="glcanvas" width="100vw" height="100vh" tabindex="1"></canvas>


        <div id="chatContainer">
            <div id="chat">
              <bot-ui></bot-ui>
            </div>
        </div>
        <div id="controlPanel">
            
            <h2 id="info"></h2>
            <form id="whoareyou">
                    <label for="entityuser">Who are you?</label></br></br><input type="text" class="entuser" id="entityuser" name="entityuser">
                    <input class="ent2" type="button" id="ent2save" name="ent2save" value="✔️" onClick="iam()">
            </form>
            <form id="Scene" style="display:none;">
                <label for="community">Community</label>
                <select onchange="" id="community" name="community">
                    <option value="YyrlsKcC">YyrlsKcC</option>
                </select>
                <input style="display:none;"  type="button" id="play" name="play" value="▶" onClick="playbtn()">
                <input style="display:none;"  type="button" id="sound" name="sound" value="🔇" onClick="soundbtn()"></br>
                
                <input type="button" id="create" name="create" value="Create new entity" onClick="createEntity()">
                </br></br>
            </form>
            <form id="ent1control">
                
                <img id="formPortrait1" class="formPortrait" src=""></br>
                <label for="entity1">Name</label><input type="text" class="ent1" id="entity1" name="entity1" disabled></br>
                <label for="ent1desc">Personality:</label><textarea class="ent1" id="ent1desc" name="ent1desc" type="text" disabled></textarea>
                <fieldset id="ent1more" style="display:none;">
                    <label for="ent1endear">Terms of Endearments</label><textarea class="ent1" id="ent1endear" name="ent1endear" type="text" disabled></textarea>
                    <label for="ent1greet">Greetings</label><textarea class="ent1" id="ent1greet" name="ent1greet" type="text" disabled></textarea>
                    <label for="ent1interests">Interests</label><textarea class="ent1" id="ent1interests" name="ent1interests" type="text" disabled></textarea>
                    <label for="ent1color">Color</label><input class="ent1" type="color" id="ent1color" name="ent1color" value="#e66465">
                    <label for="ent1img">Portrait</label><input class="ent1" type="url" name="ent1img" id="ent1img" onchange="portraitDisplay()">
                    </br><label for="ent1voice">Voice</label><input type="number" class="ent1" id="ent1voice" name="ent1voice" min="0" max="100">
                    <label for="ent1pitch">Pitch</label><input type="number" class="ent1" id="ent1pitch" name="ent1pitch" min="0" max="2">
                    <label for="ent1rate">Rate</label><input type="number" class="ent1" id="ent1rate" name="ent1rate" min="0.1" max="10">
                    </br><label for="ent1save">Save</label><input class="ent1" type="button" id="ent1save" name="ent1save" value="🖫" onClick="entsave(1)">
                    </br></br>
                    <label>Deploy</label>
                    <input class="ent1 iconBtn" type="button" id="ent1hero" name="ent1hero" value="Hero" onClick="notavailable()">
                    <input class="ent1 iconBtn" type="button" id="ent1sms" name="ent1sms" value="SMS"  onClick="notavailable()">
                    <input class="ent1 iconBtn twitter" type="button" id="ent1twitter" name="ent1twitter" value="" onClick="notavailable()">
                    <input class="ent1 iconBtn instagram" type="button" id="ent1instagram" name="ent1instagram" value="" onClick="notavailable()">
                    <input class="ent1 iconBtn facebook" type="button" id="ent1facebook" name="ent1facebook" value="" onClick="notavailable()">
                    <input class="ent1 iconBtn slack" type="button" id="ent1slack" name="ent1slack" value="" onClick="notavailable()">
                    <input class="ent1 iconBtn amazon" type="button" id="ent1amazon" name="ent1amazon" value="" onClick="notavailable()">
                    <input class="ent1 iconBtn unreal" type="button" id="ent1unreal" name="ent1unreal" value="" onClick="notavailable()">
                    <input class="ent1 iconBtn unity" type="button" id="ent1unity" name="ent1unity" value="" onClick="notavailable()">
                    <input class="ent1 iconBtn apple" type="button" id="ent1apple" name="ent1apple" value="" onClick="notavailable()">
                    <input class="ent1 iconBtn windows" type="button" id="ent1windows" name="ent1windows" value="" onClick="notavailable()">
                    <input class="ent1 iconBtn" type="button" id="ent1blockchain" name="ent1blockchain" value="Blockchain" onClick="notavailable()">
                </fieldset>
            </form>
            <form id="ent2control">
                <label for="entity2">Name</label><input type="text" class="ent2" id="entity2" name="entity2"></br>
                <img id="formPortrait2" class="formPortrait" src=""></br>
                <label for="ent2color">Color</label><input class="ent2" type="color" id="ent2color" name="ent2color" value="#e66465"></br>
                <label for="ent2img">Portrait</label><input class="ent2" type="url" name="ent2img" id="ent2img" onchange="portraitDisplay()"></br>
                
                

                <label for="ent2desc">Personality</label><textarea class="ent2" id="ent2desc" name="ent2desc" type="text"></textarea>
                <label for="ent2endear">Terms of Endearments</label><textarea class="ent2" id="ent2endear" name="ent2endear" type="text"></textarea>
                <label for="ent2greet">Greetings</label><textarea class="ent2" id="ent1greet" name="ent2greet" type="text"></textarea>
                <label for="ent2interests">Interests</label><textarea class="ent2" id="ent2interests" name="ent2interests" type="text"></textarea>
                <label for="ent2save">Save</label><input class="ent2" type="button" id="ent2save" name="ent2save" value="🖫" onClick="entsave(2)">

            </form>
        </div>
    </div>
    
 <script>
    var botui = new BotUI('chat');
    
  </script>
      <libs/>
    <script type="text/javascript" src="map_js/patch.js" async></script>
    <corelibs/>

    <script>

        // disable rubberband effect on mobile devices
        document.getElementById('glcanvas').addEventListener('touchmove', (e)=>{ e.preventDefault(); }, false);


        function patchInitialized(patch) {
            // You can now access the patch object (patch), register variable watchers and so on
        }
        var capturedPatch;
        function patchFinishedLoading(patch) {
            capturedPatch=patch;
            mapReady();
        }
        
        function setPatchVar(vari,val){
            capturedPatch.setVariable(vari,val);
        }

        document.addEventListener('CABLES.jsLoaded', function (event) {
            CABLES.patch = new CABLES.Patch({
                patch: CABLES.exportedPatch,
                prefixAssetPath: '',
                glCanvasId: 'glcanvas',
                glCanvasResizeToWindow: true,
                onPatchLoaded: patchInitialized,
                onFinishedLoading: patchFinishedLoading,allowLocalFileAccess:true,canvas:{"alpha":true}
            });
            CABLES.patch.config.hovered = function(parameters) {
                if(level==1){document.getElementById('ent1control').style.display='block';}
                document.getElementById('ent2control').style.display="none";
                document.getElementById('entity1').value=parameters[0];
                document.getElementById('formPortrait1').src=parameters[1];
                document.getElementById('ent1desc').value=parameters[2];
                document.getElementById('ent1color').value=rgbToHex(parameters[3][0]*255, parameters[3][1]*255, parameters[3][2]*255);
                document.documentElement.style.setProperty('--entity1-color', 'rgba('+parameters[3][0]*255+','+parameters[3][1]*255+','+parameters[3][2]*255+','+1+')');

                
            };
            CABLES.patch.config.enterScene = function(parameters) {
                window.location.href = 'scene.html?entity1='+parameters[0]+'&entity2='+parameters[1];
            };
            CABLES.patch.config.enterCompass = function(parameters) {
                document.getElementById('glcanvas').style.opacity=0;
                window.location.href = 'compass.html?name='+parameters[0];
            };
            CABLES.patch.config.mapValues = function(parameters) {
                allNames=parameters[0];
                allColors=parameters[1];
                allPortraits=parameters[2];
                document.getElementById('whoareyou').style.opacity=1;
            };
            CABLES.patch.config.relationships = function(parameters) {
                relationLevel(parameters[0]);
            };
            CABLES.patch.config.communities = function(parameters) {
                communityLevel(parameters[0]);
            };

        });
         function communityLevel(lvl){
            if(lvl=="true"){
                level==1;
                window.parent.postMessage('down', '*');
                document.getElementById('Scene').style.display='block';
                document.getElementById('ent1control').style.display='block';
                document.getElementById('ent2control').style.display='none';
            }else{
                level=0;
                window.parent.postMessage('up', '*');
                document.getElementById('Scene').style.display='none';
                document.getElementById('ent1control').style.display='none';
                document.getElementById('ent2control').style.display='none';
                
            }

        }
        function relationLevel(lvl){
            if(lvl=="true"){
            //window.parent.postMessage(document.getElementById('entity1').value, '*');
            document.getElementById('chatContainer').style.opacity=1;
            var cRGBA=allColors.split(',,')[allNames.split(',').indexOf(whoareyou)].split(',');
            var cHEX=rgbToHex(Math.round(cRGBA[0]*255), Math.round(cRGBA[1]*255), Math.round(cRGBA[2]*255));
            document.documentElement.style.setProperty('--entity1-color', document.getElementById('ent1color').value);
            document.documentElement.style.setProperty('--entity2-color', cHEX);
            fetch('https://www.wolframcloud.com/obj/madelaine0/say?sender='+document.getElementById('entity1').value+'&receiver='+whoareyou)
                              .then(response => response.json())
                              .then(data => {botui.message.add({
                                  loading: true
                                }).then(function (index) {
                                  setTimeout(function () {
                                    botui.message.update(index, {
                                      content: data.response,
                                      loading: false
                                    });
                                    mapChatSend();
                                  },1000);
                                });
                               });
                                        document.getElementById('ent1more').style.display='block';
                document.getElementById('Scene').style.display='none';
                document.getElementById('entity1').removeAttribute("disabled");
            }else{
                document.documentElement.style.setProperty('--entity2-color', 'grey');
                document.getElementById('chatContainer').style.opacity=0;
                botui.message.removeAll();
                document.getElementById('ent1more').style.display='none';
                document.getElementById('Scene').style.display='block';
                document.getElementById('entity1').setAttribute("disabled","disabled");
                
            }
        }
       
    </script>
  </body>
</html>